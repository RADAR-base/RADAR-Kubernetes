#!/usr/bin/env bash

# set -xv

cd "$(dirname "${BASH_SOURCE[0]}")/.."
. bin/util.sh

yq --version

cp etc/base-secrets.yaml etc/secrets.yaml

yq -i ".mongodb.auth.replicaSetKey = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".mongodb.auth.rootPassword = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".mongodb.auth.passwords[0] = \"$(generate_secret)\"" etc/secrets.yaml

yq -i ".graylog.graylog.rootPassword = \"$(generate_secret)\"" etc/secrets.yaml

yq -i ".kube_prometheus_stack.kube-prometheus-stack.grafana.adminPassword = \"$(generate_secret)\"" etc/secrets.yaml

export nginx_auth_password=$(generate_secret)
yq -i ".kube_prometheus_stack.nginx_auth = \"$(generate_secret | htpasswd -i -n thehyve)\"" etc/secrets.yaml
yq -i ".kube_prometheus_stack.nginx_auth line_comment=\"Unencrypted password: $nginx_auth_password\"" etc/secrets.yaml

yq -i ".kafka_manager.basicAuth.password = \"$(generate_secret)\"" etc/secrets.yaml

export management_portal_postgres_password=$(generate_secret)
yq -i ".postgresql.global.postgresql.auth.postgresPassword = strenv(management_portal_postgres_password)" etc/secrets.yaml
yq -i ".postgresql.auth.replicationPassword = strenv(management_portal_postgres_password)" etc/secrets.yaml
yq -i ".management_portal.postgres.password = strenv(management_portal_postgres_password)" etc/secrets.yaml
yq -i ".app_config.jdbc.password = strenv(management_portal_postgres_password)" etc/secrets.yaml
yq -i ".radar_rest_sources_backend.postgres.password = strenv(management_portal_postgres_password)" etc/secrets.yaml

yq -i ".management_portal.managementportal.common_admin_password = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.managementportal.frontend_client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.aRMT.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_upload_backend.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_upload_connect.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_rest_sources_auth_backend.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_redcap_integrator.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_fitbit_connector.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_appconfig.client_secret = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".management_portal.oauth_clients.radar_push_endpoint.client_secret = \"$(generate_secret)\"" etc/secrets.yaml


export radar_appserver_postgres_password=$(generate_secret)
yq -i ".radar_appserver_postgres_password = strenv(radar_appserver_postgres_password)" etc/secrets.yaml

yq -i ".timescaledb_password = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".grafana_password = \"$(generate_secret)\"" etc/secrets.yaml
yq -i ".grafana_metrics_password = \"$(generate_secret)\"" etc/secrets.yaml

export s3_access_key=$(generate_secret)
export s3_secret_key=$(generate_secret)
yq -i ".s3_access_key = strenv(s3_access_key)" etc/secrets.yaml
yq -i ".s3_secret_key = strenv(s3_secret_key)" etc/secrets.yaml

yq -i ".radar_upload_postgres_password = \"$(generate_secret)\"" etc/secrets.yaml

echo "Passwords and secrets have been generated successfully."
