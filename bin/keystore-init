#!/bin/bash

#cd "$( dirname "${BASH_SOURCE[0]}" )/.."

set -vx
. ./.env
. bin/util.sh

function createKeyStore() {
  keystorefile="$1"
  KEYTOOL_OPTS="-keystore ${keystorefile} -storepass radarbase -keypass radarbase $KEYSTORE_INIT_OPTS"

  if ! keytool -list $KEYTOOL_OPTS -alias radarbase-managementportal-ec >/dev/null 2>/dev/null; then
    KEYTOOL_CREATE_OPTS="-genkeypair -alias radarbase-managementportal-ec -keyalg EC -keysize 256 -sigalg SHA256withECDSA -storetype PKCS12 $KEYSTORE_CREATE_OPTS"
    if [ -n "${MANAGEMENTPORTAL_KEY_DNAME}" ]; then
      KEYTOOL_CREATE_OPTS="$KEYTOOL_CREATE_OPTS -dname ${MANAGEMENTPORTAL_KEY_DNAME}"
    fi
    echo "--> Generating keystore to hold EC keypair for JWT signing"
    keytool $KEYTOOL_CREATE_OPTS $KEYTOOL_OPTS
  else
    echo "--> ECDSA keypair for signing JWTs already exists. Not creating a new one."
  fi

  if ! keytool -list $KEYTOOL_OPTS -alias selfsigned >/dev/null 2>/dev/null; then
    KEYTOOL_CREATE_OPTS="-genkeypair -alias selfsigned -keyalg RSA -keysize 4096 -storetype PKCS12 $KEYSTORE_CREATE_OPTS"
    if [ -n "${MANAGEMENTPORTAL_KEY_DNAME}" ]; then
      KEYTOOL_CREATE_OPTS="$KEYTOOL_CREATE_OPTS -dname ${MANAGEMENTPORTAL_KEY_DNAME}"
    fi
    echo "--> Generating keystore to hold RSA keypair for JWT signing"
    keytool $KEYTOOL_CREATE_OPTS $KEYTOOL_OPTS
  else
    echo "--> RSA keypair for signing JWTs already exists. Not creating a new one."
  fi

  chmod 400 "${keystorefile}"
}

mkdir -p secrets/management-portal

if [ -f etc/management-portal/keystore.p12 ]; then
  cp etc/management-portal/keystore.p12 secrets/management-portal/keystore.p12
fi

createKeyStore secrets/management-portal/keystore.p12
