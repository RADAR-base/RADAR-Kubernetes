bases:
- ../environments.yaml

---

helmDefaults:
  atomic: false
  timeout: 240
  kubeContext: {{ .Values.kubeContext }}

repositories:
  - name: radar
    url: https://radar-base.github.io/radar-helm-charts

releases:
  - name: redis
    chart: radar/redis
    version: {{ .Values.redis._chart_version }}
    installed: {{ .Values.redis._install }}
    values:
      - "../etc/redis/values.yaml"
      - {{ .Values.redis | toYaml | indent 8 | trim }}

  - name: minio
    chart: radar/minio
    version: {{ .Values.minio._chart_version }}
    installed: {{ .Values.minio._install }}
    values:
      - "../etc/minio/values.yaml"
      - {{ .Values.minio | toYaml | indent 8 | trim }}
    set:
      - name: ingress.hostname
        value: "s3.{{ .Values.server_name }}"
      - name: apiIngress.hostname
        value: "api.s3.{{ .Values.server_name }}"
      {{- if hasKey .Values.minio "accessKey" }}
      - name: auth.rootUser
        value: {{ .Values.minio.accessKey }}
      {{- else if not (hasKey .Values.minio "auth.rootUser") }}
      - name: auth.rootUser
        value: {{ .Values.s3_access_key }}
      {{- end }}
      {{- if hasKey .Values.minio "secretKey" }}
      - name: auth.rootPassword
        value: {{ .Values.minio.secretKey }}
      {{- else if not (hasKey .Values.minio "auth.rootPassword") }}
      - name: auth.rootPassword
        value: {{ .Values.s3_secret_key }}
      {{- end }}

  - name: radar-s3-connector
    chart: radar/radar-s3-connector
    version: {{ .Values.radar_s3_connector._chart_version }}
    installed: {{ .Values.radar_s3_connector._install }}
    values:
      - {{ .Values.radar_s3_connector | toYaml | indent 8 | trim }}
      - {{ .Values.confluent_cloud | toYaml | indent 8 | trim }}
    set:
      - name: cc.enabled
        value: {{ .Values.confluent_cloud.enabled }}
      {{- if not (hasKey .Values.radar_s3_connector "bucketAccessKey") }}
      - name: bucketAccessKey
        value: {{ .Values.s3_access_key }}
      {{- end }}
      {{- if not (hasKey .Values.radar_s3_connector "bucketSecretKey") }}
      - name: bucketSecretKey
        value: {{ .Values.s3_secret_key }}
      {{- end }}

  - name: s3-proxy
    chart: radar/s3-proxy
    version: {{ .Values.s3_proxy._chart_version }}
    installed: {{ .Values.s3_proxy._install }}
    values:
      - {{ .Values.s3_proxy | toYaml | indent 8 | trim }}
    set:
      {{- if not (hasKey .Values.s3_proxy "s3.identity") }}
      - name: s3.identity
        value: {{ .Values.s3_access_key }}
      {{- end }}
      {{- if not (hasKey .Values.s3_proxy "s3.credential") }}
      - name: s3.credential
        value: {{ .Values.s3_secret_key }}
      {{- end }}

  - name: radar-output
    chart: radar/radar-output
    version: {{ .Values.radar_output._chart_version }}
    wait: true
    installed: {{ .Values.radar_output._install }}
    values:
      - {{ .Values.radar_output | toYaml | indent 8 | trim }}
    set:
      {{- if not (hasKey .Values.radar_output.source.s3 "accessToken") }}
      - name: source.s3.accessToken
        value: {{ .Values.s3_access_key }}
      {{- end }}
      {{- if not (hasKey .Values.radar_output.source.s3 "secretKey") }}
      - name: source.s3.secretKey
        value: {{ .Values.s3_secret_key }}
      {{- end }}
      {{- if not (hasKey .Values.radar_output.target.s3 "accessToken") }}
      - name: target.s3.accessToken
        value: {{ .Values.s3_access_key }}
      {{- end }}
      {{- if not (hasKey .Values.radar_output.target.s3 "secretKey") }}
      - name: target.s3.secretKey
        value: {{ .Values.s3_secret_key }}
      {{- end }}
